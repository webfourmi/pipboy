<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1a12" />
  <title>Pip-Boy Spatial v20</title>

  <link rel="manifest" href="manifest.json?v=20">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="icons/favicon.ico">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
</head>

<body>
  <header class="topbar">
    <div class="brand">PIP-BOY // ORION</div>

    <div class="topbarActions">
      <button id="openProfile" class="miniBtn" type="button">PROFIL</button>
      <div class="clock" id="clock">--:--</div>
    </div>
  </header>

  <main class="shell">
    <nav class="tabs">
      <button class="tab active" data-view="status" type="button">STATUS</button>
      <button class="tab" data-view="data" type="button">DATA</button>
      <button class="tab" data-view="inv" type="button">INV</button>
    </nav>

    <!-- STATUS -->
    <section class="view active" id="status">
      <h1>STATUT</h1>

      <div class="card">
        <h2>Identit√©</h2>
        <svg class="nameSvg" viewBox="0 0 800 120" role="img" aria-label="Nom du profil actif">
          <text id="profileNameSvg" x="18" y="82" fill="#b7ffd9" font-size="72" letter-spacing="6">P1</text>
        </svg>
        <div class="tiny" id="profileMiniLine">Campagne: ‚Äî</div>
        <p class="hint">Modifier via le bouton PROFIL.</p>
      </div>

      <div class="grid">
        <div class="card">
          <h2>√ânergie</h2>
          <div class="bar"><div class="barfill" id="energyFill" style="width:70%"></div></div>
          <div class="row">
            <input id="energy" type="range" min="0" max="100" value="70">
            <span id="energyLabel">70%</span>
          </div>
        </div>

        <div class="card">
          <h2>PV</h2>
          <div class="bar"><div class="barfill" id="hpFill" style="width:85%"></div></div>
          <div class="row">
            <input id="hp" type="range" min="0" max="100" value="85">
            <span id="hpLabel">85%</span>
          </div>
        </div>

        <div class="card">
          <h2>√âtat</h2>
          <select id="state">
            <option>OK</option>
            <option>FATIGU√â</option>
            <option>BLESS√â</option>
            <option>CRITIQUE</option>
          </select>
          <p class="hint">Sauvegarde locale automatique.</p>
        </div>
      </div>
    </section>

    <!-- DATA -->
    <section class="view" id="data">
      <h1>DATA</h1>

      <div class="card">
        <h2>Journal de bord</h2>
        <textarea id="log" rows="8" placeholder="Note rapide‚Ä¶"></textarea>
        <div class="row right">
          <button id="clearLog" class="danger" type="button">Effacer</button>
          <button id="saveLog" type="button">Sauver</button>
        </div>
      </div>

      <!-- QU√äTES -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between; gap:10px;">
          <h2 style="margin:0;">Qu√™tes</h2>
          <button id="copyDiag" type="button">Copier diagnostic</button>
        </div>
        <p class="hint">Vue tableau: EN COURS en haut, puis OK, puis RAT√âE.</p>

        <div class="row">
          <input id="questTitle" type="text" placeholder="Nouvelle qu√™te (ex: Retrouver le transpondeur)">
          <button id="addQuest" type="button">Ajouter</button>
        </div>

        <div class="row">
          <select id="questFilter">
            <option value="BOARD">Vue: Tableau (EN COURS en haut)</option>
            <option value="ALL">Filtre: Toutes (ordre actuel)</option>
            <option value="EN_COURS">EN COURS</option>
            <option value="OK">OK</option>
            <option value="RATEE">RAT√âE</option>
          </select>
          <button id="clearDoneObjectives" type="button">Nettoyer objectifs OK</button>
        </div>

        <div id="questCounts" class="tiny"></div>
        <div id="quests" class="questList"></div>
      </div>

      <!-- SAUVEGARDE -->
      <div class="card">
        <h2>Sauvegarde</h2>
        <p class="hint">Exporter/Importer tous les profils (et le profil actif).</p>

        <div class="row">
          <button id="exportAll" type="button">Exporter JSON</button>
          <label class="filebtn">
            Importer fichier
            <input id="fileImport" type="file" accept="application/json,.json">
          </label>
        </div>

        <textarea id="backupBox" rows="8" placeholder="JSON ici‚Ä¶ (export ou collage)"></textarea>

        <div class="row right">
          <button id="clearBox" class="danger" type="button">Vider</button>
          <button id="applyImport" type="button">Appliquer l‚Äôimport</button>
        </div>

        <hr class="sep">

        <h2>Profil actif</h2>
        <p class="hint">Exporter/importer uniquement le profil s√©lectionn√©. + Pack MJ (fusion missions).</p>

        <div class="row">
          <button id="exportActive" type="button">Exporter ce profil</button>
          <label class="filebtn">
            Importer dans ce profil
            <input id="fileImportActive" type="file" accept="application/json,.json">
          </label>
        </div>

        <textarea id="backupProfileBox" rows="8" placeholder="JSON du profil actif (export ou collage)‚Ä¶"></textarea>

        <div class="row right">
          <button id="clearProfileBox" class="danger" type="button">Vider</button>
          <button id="applyImportActive" type="button">Appliquer sur ce profil</button>
        </div>

        <hr class="sep">

        <h2>Pack MJ (profil actif)</h2>
        <p class="hint">√Ä partager aux joueurs: missions + briefing. Import = fusion intelligente (garde les coches/notes si possible).</p>

        <div class="row">
          <button id="exportPackActive" type="button">Exporter Pack MJ</button>
          <label class="filebtn">
            Importer Pack MJ
            <input id="fileImportPackActive" type="file" accept="application/json,.json">
          </label>
          <button id="applyPackAllProfiles" type="button">Appliquer √† tous les profils</button>
        </div>

        <textarea id="packProfileBox" rows="8" placeholder="Pack MJ (export ou collage)‚Ä¶"></textarea>

        <div class="row right">
          <button id="clearPackProfileBox" class="danger" type="button">Vider</button>
          <button id="applyPackActive" type="button">Appliquer (profil)</button>
          <button id="applyPackCampaign" type="button">Appliquer (campagne)</button>
        </div>
      </div>
    </section>

    <!-- INV -->
    <section class="view" id="inv">
      <h1>INVENTAIRE</h1>

      <div class="card">
        <h2>Objets</h2>
        <div class="row">
          <input id="itemInput" type="text" placeholder="Ajouter un objet (ex: Kit de r√©paration)">
          <button id="addItem" type="button">Ajouter</button>
        </div>

        <ul id="items" class="list"></ul>

        <div class="row right">
          <button id="clearInv" class="danger" type="button">Vider</button>
        </div>
      </div>
    </section>

    <footer class="footnote">
      <div class="tiny" id="activeProfileHint">PROFIL: -- ‚Ä¢ ‚Äî ‚Ä¢ LOCAL SAVE ‚Ä¢ v?</div>
    </footer>

    <!-- PROFIL MODAL -->
    <div id="profileModal" class="modal" aria-hidden="true">
      <div class="modalBackdrop" id="closeProfileBackdrop"></div>

      <div class="modalPanel" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
        <div class="modalHead">
          <div>
            <div class="modalTitle" id="profileModalTitle">PROFIL</div>
            <div class="tiny" id="profileModalHint">Gestion perso & campagne</div>
          </div>
          <button id="closeProfile" class="miniBtn danger" type="button">X</button>
        </div>

        <div class="modalBody">
          <div class="card">
            <h2>Choix du profil</h2>
            <div class="row">
              <select id="profileSelect"></select>
              <button id="newProfile" type="button">Nouveau</button>
            </div>
          </div>

          <div class="card">
            <h2>Identit√©</h2>
            <div class="row">
              <input id="profileName" type="text" placeholder="Nom du profil">
              <input id="profileCampaign" type="text" placeholder="Campagne (ex: ORION)">
            </div>

            <div class="row right">
              <button id="saveProfileName" type="button">Sauver</button>
              <button id="deleteProfile" class="danger" type="button">Supprimer</button>
            </div>

            <p class="hint">M√™me ‚ÄúCampagne‚Äù = Pack MJ appliqu√© en masse.</p>
          </div>

          <div class="row right">
            <button id="closeProfile2" type="button">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const APP_VERSION = "v20";

    // Horloge
    function tick(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const el = document.getElementById('clock');
      if (el) el.textContent = `${hh}:${mm}`;
    }
    tick(); setInterval(tick, 1000);

    // Navigation onglets
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        if (!target) return;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        btn.classList.add('active');
        const section = document.getElementById(target);
        if (section) section.classList.add('active');
      });
    });

    // Helpers
    const $ = (id) => document.getElementById(id);
    const store = {
      get(k, fallback){ try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch { return fallback; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== MODAL PROFIL =====
    const openProfileBtn = $("openProfile");
    const profileModal = $("profileModal");
    const closeProfileBtn = $("closeProfile");
    const closeProfileBtn2 = $("closeProfile2");
    const closeProfileBackdrop = $("closeProfileBackdrop");

    function openProfileModal(){
      if (!profileModal) return;
      profileModal.classList.add("show");
      profileModal.setAttribute("aria-hidden", "false");
      refreshProfilesUI?.();
    }

    function closeProfileModal(){
      if (!profileModal) return;
      profileModal.classList.remove("show");
      profileModal.setAttribute("aria-hidden", "true");
    }

    if (openProfileBtn) openProfileBtn.addEventListener("click", openProfileModal);
    if (closeProfileBtn) closeProfileBtn.addEventListener("click", closeProfileModal);
    if (closeProfileBtn2) closeProfileBtn2.addEventListener("click", closeProfileModal);
    if (closeProfileBackdrop) closeProfileBackdrop.addEventListener("click", closeProfileModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeProfileModal();
    });

    // Auto-fit SVG (nom long)
    function fitSvgText(textEl, maxWidth = 760, maxSize = 72, minSize = 28){
      if (!textEl) return;
      let size = maxSize;
      textEl.setAttribute("font-size", String(size));
      const getW = () => { try { return textEl.getComputedTextLength(); } catch { return 0; } };
      let w = getW();
      let guard = 0;
      while (w > maxWidth && size > minSize && guard < 80){
        size -= 2;
        textEl.setAttribute("font-size", String(size));
        w = getW();
        guard++;
      }
    }

    // MULTI-PROFILS
    const PROFILES_KEY = "pipboy_profiles";
    const ACTIVE_KEY = "pipboy_active_profile";

    function uid(){
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function defaultProfileData(){
      return {
        status: { energy: 70, hp: 85, state: "OK" },
        log: "",
        inv: [],
        quests: []
      };
    }

    function normalizeProfileData(d){
      const base = defaultProfileData();
      const out = Object.assign({}, base, d || {});
      out.status = Object.assign({}, base.status, (d && d.status) ? d.status : {});
      out.inv = Array.isArray(out.inv) ? out.inv : [];
      out.quests = Array.isArray(out.quests) ? out.quests : [];
      return out;
    }

    function getProfiles(){ return store.get(PROFILES_KEY, []); }
    function setProfiles(arr){ store.set(PROFILES_KEY, arr); }
    function getActiveId(){ return store.get(ACTIVE_KEY, null); }
    function setActiveId(id){ store.set(ACTIVE_KEY, id); }
    function profileKey(id){ return `pipboy_profile_${id}`; }
    function getProfileData(id){ return normalizeProfileData(store.get(profileKey(id), defaultProfileData())); }
    function setProfileData(id, data){ store.set(profileKey(id), normalizeProfileData(data)); }
    function deleteProfileData(id){ store.del(profileKey(id)); }

    // Migration ancien format -> profil P1
    function migrateIfNeeded(){
      const profiles = getProfiles();
      if (profiles.length > 0) return;

      const oldStatus = store.get("status", null);
      const oldLog = store.get("log", null);
      const oldInv = store.get("inv", null);

      const id = uid();
      const name = "P1";
      setProfiles([{ id, name, campaign: "ORION", createdAt: new Date().toISOString() }]);
      setActiveId(id);

      const data = defaultProfileData();
      if (oldStatus) data.status = oldStatus;
      if (typeof oldLog === "string") data.log = oldLog;
      if (Array.isArray(oldInv)) data.inv = oldInv;
      setProfileData(id, data);
    }
    migrateIfNeeded();

    // UI profils
    const profileSelect = $("profileSelect");
    const profileName = $("profileName");
    const profileCampaign = $("profileCampaign");
    const activeHint = $("activeProfileHint");
    const svgName = $("profileNameSvg");
    const profileMiniLine = $("profileMiniLine");

    function refreshProfilesUI(){
      const profiles = getProfiles();
      const activeId = getActiveId();

      if (!profileSelect) return;
      profileSelect.innerHTML = "";

      profiles.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        if (p.id === activeId) opt.selected = true;
        profileSelect.appendChild(opt);
      });

      const activeMeta = profiles.find(p => p.id === activeId) || profiles[0];
      if (activeMeta){
        if (profileName) profileName.value = activeMeta.name;
        if (profileCampaign) profileCampaign.value = activeMeta.campaign || "";
        if (activeHint) activeHint.textContent = `PROFIL: ${activeMeta.name} ‚Ä¢ ${activeMeta.campaign || "‚Äî"} ‚Ä¢ LOCAL SAVE ‚Ä¢ ${APP_VERSION}`;
        if (profileMiniLine) profileMiniLine.textContent = `Campagne: ${activeMeta.campaign || "‚Äî"}`;
        if (svgName) {
          svgName.textContent = activeMeta.name;
          svgName.setAttribute("fill", "#b7ffd9");
          fitSvgText(svgName);
        }
      }
    }

    function ensureActiveProfile(){
      const profiles = getProfiles();
      let activeId = getActiveId();
      if (!activeId || !profiles.find(p => p.id === activeId)){
        activeId = profiles[0]?.id || null;
        if (activeId) setActiveId(activeId);
      }
      return activeId;
    }

    function syncBar(rangeEl, fillEl, labelEl){
      if (!rangeEl || !fillEl || !labelEl) return;
      const val = Number(rangeEl.value);
      fillEl.style.width = `${val}%`;
      labelEl.textContent = `${val}%`;
    }

    function loadActiveProfileToUI(){
      const id = ensureActiveProfile();
      if (!id) return;

      const data = getProfileData(id);

      if ($("energy")) $("energy").value = data.status.energy ?? 70;
      if ($("hp")) $("hp").value = data.status.hp ?? 85;
      if ($("state")) $("state").value = data.status.state ?? "OK";

      syncBar($("energy"), $("energyFill"), $("energyLabel"));
      syncBar($("hp"), $("hpFill"), $("hpLabel"));

      if ($("log")) $("log").value = data.log ?? "";

      renderInv();
      renderQuests();
      refreshProfilesUI();
    }

    function saveActiveProfileFromUI(){
      const id = ensureActiveProfile();
      if (!id) return;

      const current = getProfileData(id);
      const energyEl = $("energy"), hpEl = $("hp"), stateEl = $("state"), logEl = $("log");

      const status = {
        energy: energyEl ? Number(energyEl.value) : (current.status.energy ?? 70),
        hp: hpEl ? Number(hpEl.value) : (current.status.hp ?? 85),
        state: stateEl ? stateEl.value : (current.status.state ?? "OK"),
      };

      const updated = {
        status,
        log: logEl ? logEl.value : (current.log ?? ""),
        inv: current.inv ?? [],
        quests: current.quests ?? []
      };

      setProfileData(id, updated);
    }

    ["input","change"].forEach(evt => {
      const e = $("energy");
      const h = $("hp");
      const s = $("state");
      if (e) e.addEventListener(evt, () => { syncBar(e, $("energyFill"), $("energyLabel")); saveActiveProfileFromUI(); });
      if (h) h.addEventListener(evt, () => { syncBar(h, $("hpFill"), $("hpLabel")); saveActiveProfileFromUI(); });
      if (s) s.addEventListener(evt, () => { saveActiveProfileFromUI(); });
    });

    // Journal
    const btnSaveLog = $("saveLog");
    const btnClearLog = $("clearLog");
    if (btnSaveLog) btnSaveLog.addEventListener("click", () => saveActiveProfileFromUI());
    if (btnClearLog) btnClearLog.addEventListener("click", () => { if ($("log")) $("log").value = ""; saveActiveProfileFromUI(); });

    // INVENTAIRE
    function renderInv(){
      const id = ensureActiveProfile();
      const data = id ? getProfileData(id) : defaultProfileData();

      const itemsUl = $("items");
      if (!itemsUl) return;

      const arr = Array.isArray(data.inv) ? data.inv : [];
      itemsUl.innerHTML = "";

      arr.forEach((txt, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${escapeHtml(txt)}</span><button class="mini" data-i="${idx}" type="button">X</button>`;
        itemsUl.appendChild(li);
      });

      itemsUl.querySelectorAll("button.mini").forEach(b => {
        b.addEventListener("click", () => {
          const id2 = ensureActiveProfile();
          if (!id2) return;
          const d2 = getProfileData(id2);
          const inv2 = Array.isArray(d2.inv) ? d2.inv : [];
          inv2.splice(Number(b.dataset.i), 1);
          d2.inv = inv2;
          setProfileData(id2, d2);
          renderInv();
        });
      });
    }

    const btnAddItem = $("addItem");
    if (btnAddItem) btnAddItem.addEventListener("click", () => {
      const input = $("itemInput");
      const val = input ? input.value.trim() : "";
      if (!val) return;

      const id = ensureActiveProfile();
      if (!id) return;

      const data = getProfileData(id);
      const inv = Array.isArray(data.inv) ? data.inv : [];
      inv.unshift(val);
      data.inv = inv;
      setProfileData(id, data);

      if (input) input.value = "";
      renderInv();
    });

    const btnClearInv = $("clearInv");
    if (btnClearInv) btnClearInv.addEventListener("click", () => {
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.inv = [];
      setProfileData(id, data);
      renderInv();
    });

    // QU√äTES
    const questTitle = $("questTitle");
    const addQuestBtn = $("addQuest");
    const questFilter = $("questFilter");
    const questsBox = $("quests");
    const questCounts = $("questCounts");
    const clearDoneObjectivesBtn = $("clearDoneObjectives");

    function newQuest(title){
      return { id: uid(), title, status: "EN_COURS", notes: "", objectives: [] };
    }

    function getQuestData(){
      const id = ensureActiveProfile();
      if (!id) return [];
      const data = getProfileData(id);
      return Array.isArray(data.quests) ? data.quests : [];
    }

    function setQuestData(quests){
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.quests = quests;
      setProfileData(id, data);
    }

    function renderQuests(){
      if (!questsBox) return;

      const mode = questFilter ? questFilter.value : "BOARD";
      const quests = getQuestData();

      const cEn = quests.filter(q => q.status === "EN_COURS").length;
      const cOk = quests.filter(q => q.status === "OK").length;
      const cRa = quests.filter(q => q.status === "RATEE").length;
      if (questCounts) questCounts.textContent = `EN COURS (${cEn}) ‚Ä¢ OK (${cOk}) ‚Ä¢ RAT√âE (${cRa})`;

      const statusLabel = { EN_COURS: "EN COURS", OK: "OK", RATEE: "RAT√âE" };
      const order = { EN_COURS: 0, OK: 1, RATEE: 2 };

      let shown = quests.slice();
      if (mode === "BOARD"){
        shown.sort((a,b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));
      } else if (mode === "ALL"){
      } else {
        shown = shown.filter(q => q.status === mode);
      }

      if (shown.length === 0){
        questsBox.innerHTML = `<p class="hint">Aucune qu√™te pour ce profil (ou filtre vide).</p>`;
        return;
      }

      let html = "";
      let lastStatus = null;

      for (const q of shown){
        if (mode === "BOARD" && q.status !== lastStatus){
          lastStatus = q.status;
          html += `<div class="questSection"><div class="questSectionTitle">${statusLabel[q.status] ?? q.status}</div></div>`;
        }

        const obj = Array.isArray(q.objectives) ? q.objectives : [];
        const objHtml = obj.map(o => `
          <li class="objLine">
            <label class="objLabel">
              <input type="checkbox" data-act="toggleObj" data-q="${q.id}" data-o="${o.id}" ${o.done ? "checked":""}>
              <span>${escapeHtml(o.text)}</span>
            </label>
            <button class="mini" type="button" data-act="delObj" data-q="${q.id}" data-o="${o.id}">X</button>
          </li>
        `).join("");

        html += `
          <div class="quest" data-q="${q.id}">
            <div class="questHead">
              <div class="questTitle">${escapeHtml(q.title)}</div>
              <button class="mini danger" type="button" data-act="delQuest" data-q="${q.id}">SUPPR</button>
            </div>

            <div class="row">
              <select data-act="setStatus" data-q="${q.id}">
                <option value="EN_COURS" ${q.status==="EN_COURS"?"selected":""}>EN COURS</option>
                <option value="OK" ${q.status==="OK"?"selected":""}>OK</option>
                <option value="RATEE" ${q.status==="RATEE"?"selected":""}>RAT√âE</option>
              </select>
            </div>

            <textarea rows="3" placeholder="Notes‚Ä¶" data-act="notes" data-q="${q.id}">${escapeHtml(q.notes || "")}</textarea>

            <div class="row">
              <input type="text" placeholder="Ajouter un objectif‚Ä¶" data-act="objInput" data-q="${q.id}">
              <button type="button" data-act="addObj" data-q="${q.id}">+</button>
            </div>

            <ul class="objList">${objHtml || `<li class="hint">Aucun objectif.</li>`}</ul>
          </div>
        `;
      }

      questsBox.innerHTML = html;
    }

    if (addQuestBtn) addQuestBtn.addEventListener("click", () => {
      const title = questTitle ? questTitle.value.trim() : "";
      if (!title) return;
      const quests = getQuestData();
      quests.unshift(newQuest(title));
      setQuestData(quests);
      if (questTitle) questTitle.value = "";
      renderQuests();
    });

    if (questFilter) questFilter.addEventListener("change", renderQuests);

    if (clearDoneObjectivesBtn) clearDoneObjectivesBtn.addEventListener("click", () => {
      const quests = getQuestData();
      quests.forEach(q => {
        q.objectives = (Array.isArray(q.objectives) ? q.objectives : []).filter(o => !o.done);
      });
      setQuestData(quests);
      renderQuests();
    });

    if (questsBox) {
      questsBox.addEventListener("click", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        const oid = t.getAttribute("data-o");
        if (!act || !qid) return;

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q) return;

        if (act === "delQuest"){
          setQuestData(quests.filter(x => x.id !== qid));
          renderQuests();
          return;
        }

        if (act === "addObj"){
          const input = questsBox.querySelector(`input[data-act="objInput"][data-q="${qid}"]`);
          const text = (input && input.value) ? input.value.trim() : "";
          if (!text) return;
          q.objectives = Array.isArray(q.objectives) ? q.objectives : [];
          q.objectives.push({ id: uid(), text, done:false });
          setQuestData(quests);
          renderQuests();
          return;
        }

        if (act === "delObj" && oid){
          q.objectives = (Array.isArray(q.objectives) ? q.objectives : []).filter(o => o.id !== oid);
          setQuestData(quests);
          renderQuests();
          return;
        }
      });

      questsBox.addEventListener("change", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        const oid = t.getAttribute("data-o");

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q) return;

        if (act === "setStatus" && t instanceof HTMLSelectElement){
          q.status = t.value;
          setQuestData(quests);
          renderQuests();
          return;
        }

        if (act === "toggleObj" && t instanceof HTMLInputElement && oid){
          q.objectives = Array.isArray(q.objectives) ? q.objectives : [];
          const o = q.objectives.find(x => x.id === oid);
          if (o) o.done = !!t.checked;
          setQuestData(quests);
          renderQuests();
        }
      });

      questsBox.addEventListener("blur", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        if (act !== "notes" || !qid) return;

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q || !(t instanceof HTMLTextAreaElement)) return;

        q.notes = t.value;
        setQuestData(quests);
      }, true);
    }

    // Diagnostic (copie)
    const copyDiagBtn = $("copyDiag");
    if (copyDiagBtn) copyDiagBtn.addEventListener("click", async () => {
      const id = ensureActiveProfile();
      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id);
      const data = id ? getProfileData(id) : defaultProfileData();

      const q = Array.isArray(data.quests) ? data.quests : [];
      const cEn = q.filter(x => x.status === "EN_COURS").length;
      const cOk = q.filter(x => x.status === "OK").length;
      const cRa = q.filter(x => x.status === "RATEE").length;

      const diag = [
        `PIPBOY ${APP_VERSION}`,
        `Profil: ${(meta && meta.name) ? meta.name : "?"} (${id || "no-id"})`,
        `Campagne: ${(meta && meta.campaign) ? meta.campaign : "‚Äî"}`,
        `Energie: ${data.status?.energy ?? "?"}% | PV: ${data.status?.hp ?? "?"}% | Etat: ${data.status?.state ?? "?"}`,
        `Quetes: EN_COURS ${cEn} | OK ${cOk} | RATEE ${cRa}`,
        `URL: ${location.href}`,
        `UA: ${navigator.userAgent}`
      ].join("\n");

      try {
        await navigator.clipboard.writeText(diag);
        alert("Diagnostic copi√© ‚úÖ");
      } catch {
        alert("Copie impossible (le navigateur bloque).");
      }
    });

    // PROFILS: changer / cr√©er / sauvegarder / supprimer
    if (profileSelect) profileSelect.addEventListener("change", () => {
      setActiveId(profileSelect.value);
      loadActiveProfileToUI();
    });

    const btnNewProfile = $("newProfile");
    if (btnNewProfile) btnNewProfile.addEventListener("click", () => {
      const profiles = getProfiles();
      const id = uid();
      const name = `P${profiles.length + 1}`;
      profiles.push({ id, name, campaign: "ORION", createdAt: new Date().toISOString() });
      setProfiles(profiles);
      setProfileData(id, defaultProfileData());
      setActiveId(id);
      loadActiveProfileToUI();
    });

    const btnSaveName = $("saveProfileName");
    if (btnSaveName) btnSaveName.addEventListener("click", () => {
      const id = ensureActiveProfile();
      if (!id) return;

      const newName = (profileName ? profileName.value : "").trim();
      const newCampaign = (profileCampaign ? profileCampaign.value : "").trim();

      const profiles = getProfiles();
      const p = profiles.find(x => x.id === id);
      if (p) {
        if (newName) p.name = newName;
        p.campaign = newCampaign;
      }
      setProfiles(profiles);
      refreshProfilesUI();
      loadActiveProfileToUI();
    });

    const btnDeleteProfile = $("deleteProfile");
    if (btnDeleteProfile) btnDeleteProfile.addEventListener("click", () => {
      const profiles = getProfiles();
      if (profiles.length <= 1){
        alert("Impossible: il faut garder au moins 1 profil.");
        return;
      }
      const id = ensureActiveProfile();
      const p = profiles.find(x => x.id === id);
      const ok = confirm(`Supprimer le profil "${p ? p.name : id}" ?`);
      if (!ok) return;

      const filtered = profiles.filter(x => x.id !== id);
      setProfiles(filtered);
      deleteProfileData(id);

      setActiveId(filtered[0].id);
      loadActiveProfileToUI();
    });

    // EXPORT / IMPORT (tous profils)
    const backupBox = $("backupBox");

    function exportAll(){
      const payload = {
        v: 2,
        exportedAt: new Date().toISOString(),
        activeProfileId: getActiveId(),
        profiles: getProfiles(),
        dataByProfile: {}
      };

      payload.profiles.forEach(p => {
        payload.dataByProfile[p.id] = getProfileData(p.id);
      });

      if (backupBox) backupBox.value = JSON.stringify(payload, null, 2);

      try {
        const blob = new Blob([backupBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {}
    }

    function applyImport(){
      if (!backupBox) return;
      let obj;
      try { obj = JSON.parse(backupBox.value); }
      catch { alert("JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object") { alert("JSON invalide"); return; }

      if (Array.isArray(obj.profiles) && obj.dataByProfile && typeof obj.dataByProfile === "object") {
        setProfiles(obj.profiles);
        Object.keys(obj.dataByProfile).forEach(id => {
          setProfileData(id, obj.dataByProfile[id]);
        });
        if (obj.activeProfileId) setActiveId(obj.activeProfileId);
        loadActiveProfileToUI();
        alert("Import appliqu√© ‚úÖ");
        return;
      }

      if (obj.status || obj.log || obj.inv || obj.quests) {
        const id = ensureActiveProfile();
        const data = getProfileData(id);
        if (obj.status) data.status = obj.status;
        if (typeof obj.log === "string") data.log = obj.log;
        if (Array.isArray(obj.inv)) data.inv = obj.inv;
        if (Array.isArray(obj.quests)) data.quests = obj.quests;
        setProfileData(id, data);
        loadActiveProfileToUI();
        alert("Import appliqu√© sur le profil actif ‚úÖ");
        return;
      }

      alert("Format non reconnu üòµ‚Äçüí´");
    }

    const btnExport = $("exportAll");
    const btnClear  = $("clearBox");
    const btnApply  = $("applyImport");

    if (btnExport) btnExport.addEventListener("click", exportAll);
    if (btnClear && backupBox) btnClear.addEventListener("click", () => { backupBox.value = ""; });
    if (btnApply) btnApply.addEventListener("click", applyImport);

    const fileImport = $("fileImport");
    if (fileImport) {
      fileImport.addEventListener("change", async () => {
        const file = fileImport.files && fileImport.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (backupBox) backupBox.value = text;
          applyImport();
        } catch {
          alert("Impossible de lire le fichier üòµ‚Äçüí´");
        } finally {
          fileImport.value = "";
        }
      });
    }

    // EXPORT / IMPORT : PROFIL ACTIF
    const backupProfileBox = $("backupProfileBox");

    function exportActiveProfile(){
      const id = ensureActiveProfile();
      if (!id || !backupProfileBox) return;

      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id) || { id, name: "Profil", campaign: "", createdAt: "" };

      const payload = {
        v: 1,
        exportedAt: new Date().toISOString(),
        profile: meta,
        data: getProfileData(id)
      };

      backupProfileBox.value = JSON.stringify(payload, null, 2);

      try {
        const safeName = (meta.name || "profil").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
        const blob = new Blob([backupProfileBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-${safeName || "profil"}-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {}
    }

    function applyImportActiveProfile(){
      const id = ensureActiveProfile();
      if (!id || !backupProfileBox) return;

      let obj;
      try { obj = JSON.parse(backupProfileBox.value); }
      catch { alert("JSON invalide üòµ‚Äçüí´"); return; }

      let data = null;

      if (obj && typeof obj === "object" && obj.data && typeof obj.data === "object") {
        data = obj.data;
      } else if (obj && typeof obj === "object" && (obj.status || obj.log || obj.inv || obj.quests)) {
        data = {
          status: obj.status || { energy: 70, hp: 85, state: "OK" },
          log: (typeof obj.log === "string") ? obj.log : "",
          inv: Array.isArray(obj.inv) ? obj.inv : [],
          quests: Array.isArray(obj.quests) ? obj.quests : []
        };
      }

      if (!data) { alert("Format non reconnu üòµ‚Äçüí´"); return; }

      setProfileData(id, data);
      loadActiveProfileToUI();
      alert("Profil actif mis √† jour ‚úÖ");
    }

    const btnExportActive = $("exportActive");
    const btnApplyActive  = $("applyImportActive");
    const btnClearActive  = $("clearProfileBox");

    if (btnExportActive) btnExportActive.addEventListener("click", exportActiveProfile);
    if (btnApplyActive) btnApplyActive.addEventListener("click", applyImportActiveProfile);
    if (btnClearActive && backupProfileBox) btnClearActive.addEventListener("click", () => { backupProfileBox.value = ""; });

    const fileImportActive = $("fileImportActive");
    if (fileImportActive) {
      fileImportActive.addEventListener("change", async () => {
        const file = fileImportActive.files && fileImportActive.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (backupProfileBox) backupProfileBox.value = text;
          applyImportActiveProfile();
        } catch {
          alert("Impossible de lire le fichier üòµ‚Äçüí´");
        } finally {
          fileImportActive.value = "";
        }
      });
    }

    // ===== PACK MJ =====
    const packProfileBox = $("packProfileBox");
    const btnExportPackActive = $("exportPackActive");
    const btnApplyPackActive = $("applyPackActive");
    const btnClearPackProfileBox = $("clearPackProfileBox");
    const fileImportPackActive = $("fileImportPackActive");

    function normalizeQuest(q){
      const out = Object.assign({ id: uid(), title: "", status: "EN_COURS", notes: "", objectives: [], mj: {} }, q || {});
      out.objectives = Array.isArray(out.objectives) ? out.objectives : [];
      out.mj = (out.mj && typeof out.mj === "object") ? out.mj : {};
      return out;
    }

    function mergeObjectives(existing, incoming){
      const ex = Array.isArray(existing) ? existing : [];
      const inc = Array.isArray(incoming) ? incoming : [];

      const exById = new Map(ex.filter(o => o && o.id).map(o => [o.id, o]));
      const merged = [];

      for (const o of inc){
        const obj = Object.assign({ id: uid(), text: "", done: false }, o || {});
        const same = obj.id ? exById.get(obj.id) : null;
        if (same){
          merged.push({ id: obj.id, text: (obj.text ?? same.text ?? ""), done: !!same.done });
        } else {
          merged.push({ id: obj.id, text: obj.text ?? "", done: !!obj.done });
        }
      }

      const incIds = new Set(merged.map(x => x.id));
      for (const o of ex){
        if (o && o.id && !incIds.has(o.id)){
          merged.push({ id: o.id, text: o.text ?? "", done: !!o.done });
        }
      }
      return merged;
    }

    function mergeQuests(existingQuests, incomingQuests){
      const ex = (Array.isArray(existingQuests) ? existingQuests : []).map(normalizeQuest);
      const inc = (Array.isArray(incomingQuests) ? incomingQuests : []).map(normalizeQuest);

      const exById = new Map(ex.filter(q => q.id).map(q => [q.id, q]));
      const merged = [];

      for (const q of inc){
        const same = q.id ? exById.get(q.id) : null;
        if (same){
          merged.push({
            id: q.id,
            title: q.title || same.title,
            status: same.status || q.status || "EN_COURS",
            notes: (same.notes && String(same.notes).trim().length > 0) ? same.notes : (q.notes || ""),
            objectives: mergeObjectives(same.objectives, q.objectives),
            mj: Object.assign({}, same.mj || {}, q.mj || {})
          });
        } else {
          merged.push(q);
        }
      }

      const incIds = new Set(merged.map(x => x.id));
      for (const q of ex){
        if (q && q.id && !incIds.has(q.id)){
          merged.push(q);
        }
      }

      return merged;
    }

    function exportPackActive(){
      const id = ensureActiveProfile();
      if (!id || !packProfileBox) return;

      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id) || { id, name: "Profil", campaign: "" };
      const data = getProfileData(id);

      const payload = {
        kind: "pipboy_pack_mj",
        v: 2,
        exportedAt: new Date().toISOString(),
        campaignId: (meta.campaign || "").trim() || "ORION",
        targetProfileName: meta.name,
        briefing: "",
        quests: (Array.isArray(data.quests) ? data.quests : []).map(normalizeQuest)
      };

      packProfileBox.value = JSON.stringify(payload, null, 2);

      try {
        const safeName = (meta.name || "profil").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
        const blob = new Blob([packProfileBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-pack-${safeName || "profil"}-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {}
    }

    function applyPackActive(){
      const id = ensureActiveProfile();
      if (!id || !packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object") { alert("Pack MJ invalide"); return; }
      if (obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)) {
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const data = getProfileData(id);
      data.quests = mergeQuests(data.quests, obj.quests);

      if (obj.briefing && String(obj.briefing).trim().length > 0){
        const stamp = new Date().toISOString().slice(0,10);
        const header = `[PACK MJ ${obj.campaignId || ""} ${stamp}]`.trim();
        const block = `${header}\n${obj.briefing}\n\n`;
        data.log = block + (data.log || "");
      }

      setProfileData(id, data);
      loadActiveProfileToUI();
      alert("Pack MJ appliqu√© ‚úÖ (fusion + briefing)");
    }

    // Appliquer √† tous les profils
    const btnApplyPackAllProfiles = $("applyPackAllProfiles");
    function applyPackAllProfiles(){
      const profiles = getProfiles();
      if (!profiles || profiles.length === 0) return;
      if (!packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object" || obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)){
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const ok = confirm(`Appliquer ce Pack MJ √† TOUS les profils de ce t√©l√©phone ? (${profiles.length})`);
      if (!ok) return;

      for (const p of profiles){
        const data = getProfileData(p.id);
        data.quests = mergeQuests(data.quests, obj.quests);

        if (obj.briefing && String(obj.briefing).trim().length > 0){
          const stamp = new Date().toISOString().slice(0,10);
          const header = `[PACK MJ ${obj.campaignId || ""} ${stamp}]`.trim();
          const block = `${header}\n${obj.briefing}\n\n`;
          data.log = block + (data.log || "");
        }

        setProfileData(p.id, data);
      }

      loadActiveProfileToUI();
      alert("Pack MJ appliqu√© √† tous les profils ‚úÖ");
    }

    // Appliquer √† la campagne
    const btnApplyPackCampaign = $("applyPackCampaign");
    function applyPackCampaign(){
      const profiles = getProfiles();
      if (!profiles || profiles.length === 0) return;
      if (!packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object" || obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)){
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const campaignId = String(obj.campaignId || "").trim();
      if (!campaignId){
        alert("Pack MJ: campaignId manquant. (Ex: ORION)");
        return;
      }

      const targets = profiles.filter(p => String(p.campaign || "").trim() === campaignId);
      if (targets.length === 0){
        alert(`Aucun profil avec la campagne "${campaignId}".`);
        return;
      }

      const ok = confirm(`Appliquer le Pack MJ campagne "${campaignId}" √† ${targets.length} profil(s) ?`);
      if (!ok) return;

      for (const p of targets){
        const data = getProfileData(p.id);
        data.quests = mergeQuests(data.quests, obj.quests);

        if (obj.briefing && String(obj.briefing).trim().length > 0){
          const stamp = new Date().toISOString().slice(0,10);
          const header = `[PACK MJ ${campaignId} ${stamp}]`;
          const block = `${header}\n${obj.briefing}\n\n`;
          data.log = block + (data.log || "");
        }

        setProfileData(p.id, data);
      }

      loadActiveProfileToUI();
      alert(`Pack MJ appliqu√© √† la campagne "${campaignId}" ‚úÖ`);
    }

    if (btnExportPackActive) btnExportPackActive.addEventListener("click", exportPackActive);
    if (btnApplyPackActive) btnApplyPackActive.addEventListener("click", applyPackActive);
    if (btnApplyPackAllProfiles) btnApplyPackAllProfiles.addEventListener("click", applyPackAllProfiles);
    if (btnApplyPackCampaign) btnApplyPackCampaign.addEventListener("click", applyPackCampaign);
    if (btnClearPackProfileBox && packProfileBox) btnClearPackProfileBox.addEventListener("click", () => { packProfileBox.value = ""; });

    if (fileImportPackActive) {
      fileImportPackActive.addEventListener("change", async () => {
        const file = fileImportPackActive.files && fileImportPackActive.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (packProfileBox) packProfileBox.value = text;
          applyPackActive();
        } catch {
          alert("Impossible de lire le pack üòµ‚Äçüí´");
        } finally {
          fileImportPackActive.value = "";
        }
      });
    }

    // Export/import active/all buttons already wired earlier
    // (Keep as-is; handlers defined above)

    // Chargement initial
    refreshProfilesUI();
    loadActiveProfileToUI();

    // PWA offline
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js", { scope: "./" });
    }
  </script>
</body>
</html>
