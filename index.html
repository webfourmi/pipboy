<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1a12" />
  <title>Pip-Boy Spatial v23</title>

  <link rel="manifest" href="manifest.json?v=23">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="icons/favicon.ico">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
</head>

<body>
  <div id="boot" class="boot show" aria-hidden="false">
   <div class="bootInner">
    <div class="bootBrand">PIP-BOY // ORION</div>
    <div class="bootLines">
      <div class="bootLine">INITIALISATION‚Ä¶</div>
      <div class="bootLine">CHARGEMENT MODULES: STATUS / DATA / INV</div>
      <div class="bootLine">V√âRIF MEMOIRE LOCALE‚Ä¶ OK</div>
      <div class="bootLine">SYNC PROFIL‚Ä¶ OK</div>
      <div class="bootLine">D√âMARRAGE INTERFACE</div>
    </div>
     <div class="bootBar"><div id="bootFill" class="bootFill"></div></div>
     <div class="bootHint">Touchez pour passer</div>
    </div>
 </div>
  <header class="topbar">
    <div class="brand">PIP-BOY // ORION</div>

    <div class="topbarActions">
      <button id="openProfile" class="miniBtn" type="button">PROFIL</button>
      <button id="openIO" class="miniBtn" type="button">IMPORT/EXPORT</button>
      <div class="clock" id="clock">--:--</div>
    </div>
  </header>

  <main class="shell">
    <nav class="tabs">
      <button class="tab active" data-view="status" type="button">STATUS</button>
      <button class="tab" data-view="data" type="button">DATA</button>
      <button class="tab" data-view="inv" type="button">INV</button>
    </nav>

    <!-- STATUS -->
    <section class="view active" id="status">
      <h1>STATUS</h1>

      <div class="card">
        <h2>Identit√©</h2>
        <svg class="nameSvg" viewBox="0 0 800 120" role="img" aria-label="Nom du profil actif">
          <text id="profileNameSvg" x="18" y="82" fill="#b7ffd9" font-size="72" letter-spacing="6">P1</text>
        </svg>
        <div class="tiny" id="profileMiniLine">Campagne: ‚Äî</div>
        <p class="hint">Modifier via le bouton PROFIL.</p>
      </div>

      <!-- FICHE PJ -->
      <div class="card">
        <h2>Fiche PJ</h2>

        <div class="gridSheet">
          <!-- PV -->
          <div class="card sub">
            <h3>Points de vie</h3>
            <div class="bar"><div class="barfill" id="pjHpFill" style="width:50%"></div></div>
            <div class="row">
              <input id="pjHp" type="range" min="0" max="20" value="10">
              <span id="pjHpLabel">10/20</span>
              <input id="pjHpMax" type="number" min="1" max="999" step="1" value="20" style="width:84px;">
            </div>
            <p class="hint">Max PV</p>
            <textarea id="pjWounds" rows="2" placeholder="Blessures (description)‚Ä¶"></textarea>
          </div>

          <!-- SAN -->
          <div class="card sub">
            <h3>Sant√© mentale</h3>
            <div class="bar"><div class="barfill" id="pjSanFill" style="width:50%"></div></div>
            <div class="row">
              <input id="pjSan" type="range" min="0" max="20" value="10">
              <span id="pjSanLabel">10/20</span>
              <input id="pjSanMax" type="number" min="1" max="999" step="1" value="20" style="width:84px;">
            </div>
            <p class="hint">Max SAN</p>
            <textarea id="pjTroubles" rows="2" placeholder="Troubles mentaux (description)‚Ä¶"></textarea>
          </div>

          <!-- Caract√©ristiques -->
          <div class="card sub" style="grid-column: 1 / -1;">
            <h3>Caract√©ristiques (valeur / max)</h3>

            <div class="statsGrid">
              <div class="statLine" style="grid-template-columns: 70px 1fr 44px 74px;">
                <div class="statName">FOR</div>
                <input id="stat_for" type="range" min="0" max="20" value="10">
                <div class="statVal" id="stat_for_val">10</div>
                <input id="stat_for_max" type="number" min="1" max="999" step="1" value="20" style="width:74px;">
              </div>

              <div class="statLine" style="grid-template-columns: 70px 1fr 44px 74px;">
                <div class="statName">DEX</div>
                <input id="stat_dex" type="range" min="0" max="20" value="10">
                <div class="statVal" id="stat_dex_val">10</div>
                <input id="stat_dex_max" type="number" min="1" max="999" step="1" value="20" style="width:74px;">
              </div>

              <div class="statLine" style="grid-template-columns: 70px 1fr 44px 74px;">
                <div class="statName">END</div>
                <input id="stat_end" type="range" min="0" max="20" value="10">
                <div class="statVal" id="stat_end_val">10</div>
                <input id="stat_end_max" type="number" min="1" max="999" step="1" value="20" style="width:74px;">
              </div>

              <div class="statLine" style="grid-template-columns: 70px 1fr 44px 74px;">
                <div class="statName">INT</div>
                <input id="stat_int" type="range" min="0" max="20" value="10">
                <div class="statVal" id="stat_int_val">10</div>
                <input id="stat_int_max" type="number" min="1" max="999" step="1" value="20" style="width:74px;">
              </div>

              <div class="statLine" style="grid-template-columns: 70px 1fr 44px 74px;">
                <div class="statName">INTU</div>
                <input id="stat_intu" type="range" min="0" max="20" value="10">
                <div class="statVal" id="stat_intu_val">10</div>
                <input id="stat_intu_max" type="number" min="1" max="999" step="1" value="20" style="width:74px;">
              </div>
            </div>
          </div>

          <!-- Comp√©tences -->
          <div class="card sub" style="grid-column: 1 / -1;">
            <h3>Comp√©tences (%)</h3>
            <div class="skillsGrid" id="skillsGrid"></div>
            <p class="hint">0‚Äì100. Simple et efficace.</p>
          </div>

          <!-- Combat -->
          <div class="card sub" style="grid-column: 1 / -1;">
            <h3>Combat</h3>
            <div class="combatGrid">
              <label class="field">
                <span>Combat √† distance (%)</span>
                <input id="combat_ranged" type="number" min="0" max="100" step="1" value="0">
              </label>

              <label class="field">
                <span>Combat au corps √† corps (%)</span>
                <input id="combat_melee" type="number" min="0" max="100" step="1" value="0">
              </label>

              <label class="field">
                <span>Protection</span>
                <input id="combat_prot" type="number" min="0" max="999" step="1" value="0">
              </label>
            </div>

            <div class="weaponsGrid">
              <div class="weaponCard">
                <div class="tiny">ARME 1</div>
                <input id="w1_name" type="text" placeholder="Nom">
                <input id="w1_dmg" type="text" placeholder="D√©g√¢ts (ex: 1d6+2)">
              </div>

              <div class="weaponCard">
                <div class="tiny">ARME 2</div>
                <input id="w2_name" type="text" placeholder="Nom">
                <input id="w2_dmg" type="text" placeholder="D√©g√¢ts (ex: 2d8)">
              </div>
            </div>
          </div>

          <!-- Comp√©tences sp√©ciales -->
          <div class="card sub" style="grid-column: 1 / -1;">
            <h3>Comp√©tences sp√©ciales (%)</h3>

            <div class="row">
              <input id="specName" type="text" placeholder="Nom (ex: Cryptage ancien)">
              <input id="specVal" type="number" min="0" max="100" step="1" placeholder="%">
              <button id="addSpec" type="button">Ajouter</button>
            </div>

            <div id="specList" class="specList"></div>
            <p class="hint">Ajout au fil des sessions.</p>
          </div>

        </div>
      </div>
    </section>

    <!-- DATA -->
    <section class="view" id="data">
      <h1>DATA</h1>

      <div class="card">
        <h2>Journal de bord</h2>
        <textarea id="log" rows="8" placeholder="Note rapide‚Ä¶"></textarea>
        <div class="row right">
          <button id="clearLog" class="danger" type="button">Effacer</button>
          <button id="saveLog" type="button">Sauver</button>
        </div>
      </div>

      <!-- QU√äTES -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between; gap:10px;">
          <h2 style="margin:0;">Qu√™tes</h2>
        </div>
        <p class="hint">Vue tableau: EN COURS en haut, puis OK, puis RAT√âE.</p>

        <div class="row">
          <input id="questTitle" type="text" placeholder="Nouvelle qu√™te (ex: Retrouver le transpondeur)">
          <button id="addQuest" type="button">Ajouter</button>
        </div>

        <div class="row">
          <select id="questFilter">
            <option value="BOARD">Vue: Tableau (EN COURS en haut)</option>
            <option value="ALL">Filtre: Toutes (ordre actuel)</option>
            <option value="EN_COURS">EN COURS</option>
            <option value="OK">OK</option>
            <option value="RATEE">RAT√âE</option>
          </select>
          <button id="clearDoneObjectives" type="button">Nettoyer objectifs OK</button>
        </div>

        <div id="questCounts" class="tiny"></div>
        <div id="quests" class="questList"></div>
      </div>
    </section>

    <!-- INV -->
    <section class="view" id="inv">
      <h1>INVENTAIRE</h1>

      <div class="card">
        <h2>Objets</h2>
        <div class="row">
          <input id="itemInput" type="text" placeholder="Ajouter un objet (ex: Kit de r√©paration)">
          <button id="addItem" type="button">Ajouter</button>
        </div>

        <ul id="items" class="list"></ul>

        <div class="row right">
          <button id="clearInv" class="danger" type="button">Vider</button>
        </div>
      </div>
    </section>

    <footer class="footnote">
      <div class="tiny" id="activeProfileHint">PROFIL: -- ‚Ä¢ ‚Äî ‚Ä¢ LOCAL SAVE ‚Ä¢ v?</div>
    </footer>

    <!-- PROFIL MODAL -->
    <div id="profileModal" class="modal" aria-hidden="true">
      <div class="modalBackdrop" id="closeProfileBackdrop"></div>

      <div class="modalPanel" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
        <div class="modalHead">
          <div>
            <div class="modalTitle" id="profileModalTitle">PROFIL</div>
            <div class="tiny" id="profileModalHint">Gestion perso & campagne</div>
          </div>
          <button id="closeProfile" class="miniBtn" type="button">FERMER</button>
        </div>

        <div class="modalBody">
          <div class="card">
            <h2>Choix du profil</h2>
            <div class="row">
              <select id="profileSelect"></select>
              <button id="newProfile" type="button">Nouveau</button>
            </div>
          </div>

          <div class="card">
            <h2>Identit√©</h2>
            <div class="row">
              <input id="profileName" type="text" placeholder="Nom du profil">
              <input id="profileCampaign" type="text" placeholder="Campagne (ex: ORION)">
            </div>

            <div class="row right">
              <button id="saveProfileName" type="button">Sauver</button>
              <button id="deleteProfile" class="danger" type="button">Supprimer</button>
            </div>

            <p class="hint">M√™me ‚ÄúCampagne‚Äù = Pack MJ appliqu√© en masse.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- IMPORT/EXPORT MODAL -->
    <div id="ioModal" class="modal" aria-hidden="true">
      <div class="modalBackdrop" id="closeIOBackdrop"></div>

      <div class="modalPanel" role="dialog" aria-modal="true" aria-labelledby="ioModalTitle">
        <div class="modalHead">
          <div>
            <div class="modalTitle" id="ioModalTitle">IMPORT / EXPORT</div>
            <div class="tiny">Backups, profil actif, Pack MJ</div>
          </div>
          <button id="closeIO" class="miniBtn" type="button">FERMER</button>
        </div>

        <div class="modalBody">
          <div class="card">
            <h2>Support</h2>
            <p class="hint">√Ä coller au MJ en cas de souci (version, campagne, qu√™tes‚Ä¶).</p>
            <div class="row">
              <button id="copyDiag" type="button">Copier diagnostic</button>
            </div>
          </div>

          <div class="card">
            <h2>Sauvegarde</h2>
            <p class="hint">Exporter/Importer tous les profils (et le profil actif).</p>

            <div class="row">
              <button id="exportAll" type="button">Exporter JSON</button>
              <label class="filebtn">
                Importer fichier
                <input id="fileImport" type="file" accept="application/json,.json">
              </label>
            </div>

            <textarea id="backupBox" rows="8" placeholder="JSON ici‚Ä¶ (export ou collage)"></textarea>

            <div class="row right">
              <button id="clearBox" class="danger" type="button">Vider</button>
              <button id="applyImport" type="button">Appliquer l‚Äôimport</button>
            </div>

            <hr class="sep">

            <h2>Profil actif</h2>
            <p class="hint">Exporter/importer uniquement le profil s√©lectionn√©.</p>

            <div class="row">
              <button id="exportActive" type="button">Exporter ce profil</button>
              <label class="filebtn">
                Importer dans ce profil
                <input id="fileImportActive" type="file" accept="application/json,.json">
              </label>
            </div>

            <textarea id="backupProfileBox" rows="8" placeholder="JSON du profil actif (export ou collage)‚Ä¶"></textarea>

            <div class="row right">
              <button id="clearProfileBox" class="danger" type="button">Vider</button>
              <button id="applyImportActive" type="button">Appliquer sur ce profil</button>
            </div>

            <hr class="sep">

            <h2>Pack MJ (profil actif)</h2>
            <p class="hint">Exporter/importer un pack MJ. Import = fusion intelligente (garde coches/notes si possible).</p>

            <div class="row">
              <button id="exportPackActive" type="button">Exporter Pack MJ</button>
              <label class="filebtn">
                Importer Pack MJ
                <input id="fileImportPackActive" type="file" accept="application/json,.json">
              </label>
              <button id="applyPackAllProfiles" type="button">Appliquer √† tous les profils</button>
            </div>

            <textarea id="packProfileBox" rows="8" placeholder="Pack MJ (export ou collage)‚Ä¶"></textarea>

            <div class="row right">
              <button id="clearPackProfileBox" class="danger" type="button">Vider</button>
              <button id="applyPackActive" type="button">Appliquer (profil)</button>
              <button id="applyPackCampaign" type="button">Appliquer (campagne)</button>
            </div>
          </div>

        </div>
      </div>
    </div>

  </main>

  <script>
    const APP_VERSION = "v23";

    // Horloge
    function tick(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const el = document.getElementById('clock');
      if (el) el.textContent = `${hh}:${mm}`;
    }
    tick(); setInterval(tick, 1000);

    // Navigation onglets
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        if (!target) return;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        btn.classList.add('active');
        const section = document.getElementById(target);
        if (section) section.classList.add('active');
      });
    });

    // Helpers
    const $ = (id) => document.getElementById(id);
    const store = {
      get(k, fallback){ try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch { return fallback; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== MODALS =====
    const openProfileBtn = $("openProfile");
    const profileModal = $("profileModal");
    const closeProfileBtn = $("closeProfile");
    const closeProfileBackdrop = $("closeProfileBackdrop");

    function openProfileModal(){
      if (!profileModal) return;
      profileModal.classList.add("show");
      profileModal.setAttribute("aria-hidden", "false");
      refreshProfilesUI?.();
    }
    function closeProfileModal(){
      if (!profileModal) return;
      profileModal.classList.remove("show");
      profileModal.setAttribute("aria-hidden", "true");
    }
    if (openProfileBtn) openProfileBtn.addEventListener("click", openProfileModal);
    if (closeProfileBtn) closeProfileBtn.addEventListener("click", closeProfileModal);
    if (closeProfileBackdrop) closeProfileBackdrop.addEventListener("click", closeProfileModal);

    const openIOBtn = $("openIO");
    const ioModal = $("ioModal");
    const closeIOBtn = $("closeIO");
    const closeIOBackdrop = $("closeIOBackdrop");

    function openIOModal(){
      if (!ioModal) return;
      ioModal.classList.add("show");
      ioModal.setAttribute("aria-hidden", "false");
      refreshProfilesUI?.();
    }
    function closeIOModal(){
      if (!ioModal) return;
      ioModal.classList.remove("show");
      ioModal.setAttribute("aria-hidden", "true");
    }
    if (openIOBtn) openIOBtn.addEventListener("click", openIOModal);
    if (closeIOBtn) closeIOBtn.addEventListener("click", closeIOModal);
    if (closeIOBackdrop) closeIOBackdrop.addEventListener("click", closeIOModal);

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      if (ioModal && ioModal.classList.contains("show")) { closeIOModal(); return; }
      if (profileModal && profileModal.classList.contains("show")) closeProfileModal();
    });

    // Auto-fit SVG (nom long)
    function fitSvgText(textEl, maxWidth = 760, maxSize = 72, minSize = 28){
      if (!textEl) return;
      let size = maxSize;
      textEl.setAttribute("font-size", String(size));
      const getW = () => { try { return textEl.getComputedTextLength(); } catch { return 0; } };
      let w = getW();
      let guard = 0;
      while (w > maxWidth && size > minSize && guard < 80){
        size -= 2;
        textEl.setAttribute("font-size", String(size));
        w = getW();
        guard++;
      }
    }

    // ===== MULTI-PROFILS =====
    const PROFILES_KEY = "pipboy_profiles";
    const ACTIVE_KEY = "pipboy_active_profile";

    function uid(){
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function defaultProfileData(){
      return {
        log: "",
        inv: [],
        quests: [],
        sheet: {
          hp: 10,
          hpMax: 20,
          wounds: "",
          san: 10,
          sanMax: 20,
          troubles: "",
          stats: {
            for: { v: 10, max: 20 },
            dex: { v: 10, max: 20 },
            end: { v: 10, max: 20 },
            int: { v: 10, max: 20 },
            intu:{ v: 10, max: 20 }
          },
          skills: {},
          combat: { ranged: 0, melee: 0, prot: 0, w1:{name:"", dmg:""}, w2:{name:"", dmg:""} },
          specials: []
        }
      };
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function normalizeProfileData(d){
      const base = defaultProfileData();
      const out = Object.assign({}, base, d || {});
      out.inv = Array.isArray(out.inv) ? out.inv : [];
      out.quests = Array.isArray(out.quests) ? out.quests : [];
      out.log = (typeof out.log === "string") ? out.log : "";

      out.sheet = Object.assign({}, base.sheet, (d && d.sheet) ? d.sheet : {});

      // Compat: anciennes versions hp20/san20
      if (out.sheet.hp === undefined && out.sheet.hp20 !== undefined) out.sheet.hp = out.sheet.hp20;
      if (out.sheet.san === undefined && out.sheet.san20 !== undefined) out.sheet.san = out.sheet.san20;

      out.sheet.hpMax = Number.isFinite(+out.sheet.hpMax) && +out.sheet.hpMax > 0 ? +out.sheet.hpMax : base.sheet.hpMax;
      out.sheet.sanMax = Number.isFinite(+out.sheet.sanMax) && +out.sheet.sanMax > 0 ? +out.sheet.sanMax : base.sheet.sanMax;

      out.sheet.hp = Number.isFinite(+out.sheet.hp) ? +out.sheet.hp : base.sheet.hp;
      out.sheet.san = Number.isFinite(+out.sheet.san) ? +out.sheet.san : base.sheet.san;

      out.sheet.hp = clamp(out.sheet.hp, 0, out.sheet.hpMax);
      out.sheet.san = clamp(out.sheet.san, 0, out.sheet.sanMax);

      out.sheet.wounds = (typeof out.sheet.wounds === "string") ? out.sheet.wounds : "";
      out.sheet.troubles = (typeof out.sheet.troubles === "string") ? out.sheet.troubles : "";

      // Skills
      out.sheet.skills = (out.sheet.skills && typeof out.sheet.skills === "object") ? out.sheet.skills : {};

      // Combat
      out.sheet.combat = Object.assign({}, base.sheet.combat, (out.sheet.combat || {}));
      out.sheet.combat.w1 = Object.assign({}, base.sheet.combat.w1, (out.sheet.combat.w1 || {}));
      out.sheet.combat.w2 = Object.assign({}, base.sheet.combat.w2, (out.sheet.combat.w2 || {}));
      out.sheet.combat.ranged = Number.isFinite(+out.sheet.combat.ranged) ? +out.sheet.combat.ranged : 0;
      out.sheet.combat.melee  = Number.isFinite(+out.sheet.combat.melee) ? +out.sheet.combat.melee : 0;
      out.sheet.combat.prot   = Number.isFinite(+out.sheet.combat.prot) ? +out.sheet.combat.prot : 0;

      // Specials
      out.sheet.specials = Array.isArray(out.sheet.specials) ? out.sheet.specials : [];

      // Stats: compat + normalisation {v,max}
      const s = (out.sheet.stats && typeof out.sheet.stats === "object") ? out.sheet.stats : {};
      ["for","dex","end","int","intu"].forEach(k => {
        let cur = s[k];

        // compat: ancienne version -> nombre
        if (typeof cur === "number") cur = { v: cur, max: 20 };

        if (!cur || typeof cur !== "object") cur = { v: base.sheet.stats[k].v, max: base.sheet.stats[k].max };

        cur.max = Number.isFinite(+cur.max) && +cur.max > 0 ? +cur.max : base.sheet.stats[k].max;
        cur.v = Number.isFinite(+cur.v) ? +cur.v : base.sheet.stats[k].v;
        cur.v = clamp(cur.v, 0, cur.max);

        s[k] = cur;
      });
      out.sheet.stats = s;

      return out;
    }

    function getProfiles(){ return store.get(PROFILES_KEY, []); }
    function setProfiles(arr){ store.set(PROFILES_KEY, arr); }
    function getActiveId(){ return store.get(ACTIVE_KEY, null); }
    function setActiveId(id){ store.set(ACTIVE_KEY, id); }
    function profileKey(id){ return `pipboy_profile_${id}`; }
    function getProfileData(id){ return normalizeProfileData(store.get(profileKey(id), defaultProfileData())); }
    function setProfileData(id, data){ store.set(profileKey(id), normalizeProfileData(data)); }
    function deleteProfileData(id){ store.del(profileKey(id)); }

    // Migration ancien format -> profil P1 (log/inv uniquement)
    function migrateIfNeeded(){
      const profiles = getProfiles();
      if (profiles.length > 0) return;

      const oldLog = store.get("log", null);
      const oldInv = store.get("inv", null);

      const id = uid();
      setProfiles([{ id, name: "P1", campaign: "ORION", createdAt: new Date().toISOString() }]);
      setActiveId(id);

      const data = defaultProfileData();
      if (typeof oldLog === "string") data.log = oldLog;
      if (Array.isArray(oldInv)) data.inv = oldInv;

      setProfileData(id, data);
    }
    migrateIfNeeded();

    // UI profils
    const profileSelect = $("profileSelect");
    const profileName = $("profileName");
    const profileCampaign = $("profileCampaign");
    const activeHint = $("activeProfileHint");
    const svgName = $("profileNameSvg");
    const profileMiniLine = $("profileMiniLine");

    function refreshProfilesUI(){
      const profiles = getProfiles();
      const activeId = getActiveId();

      if (!profileSelect) return;
      profileSelect.innerHTML = "";

      profiles.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        if (p.id === activeId) opt.selected = true;
        profileSelect.appendChild(opt);
      });

      const activeMeta = profiles.find(p => p.id === activeId) || profiles[0];
      if (activeMeta){
        if (profileName) profileName.value = activeMeta.name;
        if (profileCampaign) profileCampaign.value = activeMeta.campaign || "";
        if (activeHint) activeHint.textContent = `PROFIL: ${activeMeta.name} ‚Ä¢ ${activeMeta.campaign || "‚Äî"} ‚Ä¢ LOCAL SAVE ‚Ä¢ ${APP_VERSION}`;
        if (profileMiniLine) profileMiniLine.textContent = `Campagne: ${activeMeta.campaign || "‚Äî"}`;
        if (svgName) {
          svgName.textContent = activeMeta.name;
          svgName.setAttribute("fill", "#b7ffd9");
          fitSvgText(svgName);
        }
      }
    }

    function ensureActiveProfile(){
      const profiles = getProfiles();
      let activeId = getActiveId();
      if (!activeId || !profiles.find(p => p.id === activeId)){
        activeId = profiles[0]?.id || null;
        if (activeId) setActiveId(activeId);
      }
      return activeId;
    }

    // ===== FICHE PJ =====
    const SKILLS = [
      "adaptation","astrophysique","mathematiques","biologie","geologie",
      "bricoler","bidouiller","comprendre_etrange","convaincre",
      "courir_sauter_nager","deplacement_zero_g","discretion","garder_son_calme",
      "observer","pilotage","programmation","reflexes","soigner","survie"
    ];

    const SKILLS_LABEL = {
      adaptation: "Adaptation",
      astrophysique: "Astrophysique",
      mathematiques: "Math√©matiques",
      biologie: "Biologie",
      geologie: "G√©ologie",
      bricoler: "Bricoler",
      bidouiller: "Bidouiller",
      comprendre_etrange: "Comprendre l‚Äô√©trange",
      convaincre: "Convaincre",
      courir_sauter_nager: "Courir / Sauter / Nager",
      deplacement_zero_g: "D√©placement en z√©ro G",
      discretion: "Discr√©tion",
      garder_son_calme: "Garder son calme",
      observer: "Observer",
      pilotage: "Pilotage",
      programmation: "Programmation",
      reflexes: "R√©flexes",
      soigner: "Soigner",
      survie: "Survie"
    };

    function buildSkillsUI(){
      const box = $("skillsGrid");
      if (!box) return;
      box.innerHTML = "";
      SKILLS.forEach(k => {
        const wrap = document.createElement("label");
        wrap.className = "field";
        wrap.innerHTML = `
          <span>${SKILLS_LABEL[k] || k}</span>
          <input data-skill="${k}" type="number" min="0" max="100" step="1" value="0">
        `;
        box.appendChild(wrap);
      });
    }
    buildSkillsUI();

    function syncGauge(rangeEl, fillEl, labelEl, max){
      if (!rangeEl || !fillEl || !labelEl) return;
      const v = Number(rangeEl.value);
      const m = Math.max(1, Number(max || rangeEl.max || 20));
      const pct = Math.round((v / m) * 100);
      fillEl.style.width = `${pct}%`;
      labelEl.textContent = `${v}/${m}`;
    }

    function renderSpecials(list){
      const box = $("specList");
      if (!box) return;
      box.innerHTML = "";

      if (!list || list.length === 0){
        box.innerHTML = `<p class="hint">Aucune comp√©tence sp√©ciale.</p>`;
        return;
      }

      list.forEach(sp => {
        const row = document.createElement("div");
        row.className = "specRow";
        row.innerHTML = `
          <div>${escapeHtml(sp.name || "")}</div>
          <div style="text-align:right; font-weight:900;">${Number(sp.val || 0)}%</div>
          <button class="mini danger" type="button" data-del="${sp.id}">X</button>
        `;
        box.appendChild(row);
      });

      box.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = ensureActiveProfile();
          if (!id) return;
          const data = getProfileData(id);
          const arr = Array.isArray(data.sheet?.specials) ? data.sheet.specials : [];
          data.sheet.specials = arr.filter(x => x.id !== btn.getAttribute("data-del"));
          setProfileData(id, data);
          renderSpecials(data.sheet.specials);
        });
      });
    }

    function loadSheetToUI(data){
      const sh = data.sheet || defaultProfileData().sheet;

      // PV
      if ($("pjHpMax")) $("pjHpMax").value = sh.hpMax ?? 20;
      if ($("pjHp")) { $("pjHp").max = String(sh.hpMax ?? 20); $("pjHp").value = sh.hp ?? 0; }
      syncGauge($("pjHp"), $("pjHpFill"), $("pjHpLabel"), sh.hpMax);
      if ($("pjWounds")) $("pjWounds").value = sh.wounds ?? "";

      // SAN
      if ($("pjSanMax")) $("pjSanMax").value = sh.sanMax ?? 20;
      if ($("pjSan")) { $("pjSan").max = String(sh.sanMax ?? 20); $("pjSan").value = sh.san ?? 0; }
      syncGauge($("pjSan"), $("pjSanFill"), $("pjSanLabel"), sh.sanMax);
      if ($("pjTroubles")) $("pjTroubles").value = sh.troubles ?? "";

      // Stats
      const setStat = (key) => {
        const r = $(`stat_${key}`);
        const v = $(`stat_${key}_val`);
        const m = $(`stat_${key}_max`);
        const st = sh.stats?.[key] || { v:10, max:20 };

        if (m) m.value = st.max ?? 20;
        if (r) { r.max = String(st.max ?? 20); r.value = st.v ?? 10; }
        if (v) v.textContent = String(st.v ?? 10);
      };
      ["for","dex","end","int","intu"].forEach(setStat);

      // Skills
      const skills = sh.skills || {};
      document.querySelectorAll("#skillsGrid input[data-skill]").forEach(inp => {
        const k = inp.getAttribute("data-skill");
        inp.value = Number(skills[k] ?? 0);
      });

      // Combat
      if ($("combat_ranged")) $("combat_ranged").value = Number(sh.combat?.ranged ?? 0);
      if ($("combat_melee")) $("combat_melee").value = Number(sh.combat?.melee ?? 0);
      if ($("combat_prot")) $("combat_prot").value = Number(sh.combat?.prot ?? 0);

      if ($("w1_name")) $("w1_name").value = sh.combat?.w1?.name ?? "";
      if ($("w1_dmg")) $("w1_dmg").value = sh.combat?.w1?.dmg ?? "";
      if ($("w2_name")) $("w2_name").value = sh.combat?.w2?.name ?? "";
      if ($("w2_dmg")) $("w2_dmg").value = sh.combat?.w2?.dmg ?? "";

      renderSpecials(sh.specials || []);
    }

    function readSheetFromUI(){
      const sh = defaultProfileData().sheet;

      sh.hpMax = Number($("pjHpMax")?.value || 20);
      sh.hp = Number($("pjHp")?.value || 0);
      sh.hp = clamp(sh.hp, 0, sh.hpMax);
      sh.wounds = $("pjWounds")?.value || "";

      sh.sanMax = Number($("pjSanMax")?.value || 20);
      sh.san = Number($("pjSan")?.value || 0);
      sh.san = clamp(sh.san, 0, sh.sanMax);
      sh.troubles = $("pjTroubles")?.value || "";

      const getStat = (k) => {
        const max = Number($(`stat_${k}_max`)?.value || 20);
        const v = Number($(`stat_${k}`)?.value || 0);
        return { max: Math.max(1, max), v: clamp(v, 0, Math.max(1, max)) };
      };

      sh.stats = {
        for: getStat("for"),
        dex: getStat("dex"),
        end: getStat("end"),
        int: getStat("int"),
        intu: getStat("intu")
      };

      const skills = {};
      document.querySelectorAll("#skillsGrid input[data-skill]").forEach(inp => {
        const k = inp.getAttribute("data-skill");
        skills[k] = Number(inp.value || 0);
      });
      sh.skills = skills;

      sh.combat = {
        ranged: Number($("combat_ranged")?.value || 0),
        melee: Number($("combat_melee")?.value || 0),
        prot: Number($("combat_prot")?.value || 0),
        w1: { name: $("w1_name")?.value || "", dmg: $("w1_dmg")?.value || "" },
        w2: { name: $("w2_name")?.value || "", dmg: $("w2_dmg")?.value || "" }
      };

      // specials: on garde la liste stock√©e
      const id = ensureActiveProfile();
      const data = id ? getProfileData(id) : defaultProfileData();
      sh.specials = Array.isArray(data.sheet?.specials) ? data.sheet.specials : [];

      return sh;
    }

    function saveSheet(){
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.sheet = readSheetFromUI();
      setProfileData(id, data);
    }

    // ===== LOG / INV / QU√äTES =====
    function loadActiveProfileToUI(){
      const id = ensureActiveProfile();
      if (!id) return;

      const data = getProfileData(id);

      if ($("log")) $("log").value = data.log ?? "";

      renderInv();
      renderQuests();
      refreshProfilesUI();
      loadSheetToUI(data);
    }

    function saveLogOnly(){
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.log = $("log") ? $("log").value : (data.log || "");
      setProfileData(id, data);
    }

    // Events Fiche PJ
    ["input","change"].forEach(evt => {
      const pjHp = $("pjHp");
      const pjSan = $("pjSan");

      if (pjHp) pjHp.addEventListener(evt, () => { saveSheet(); const d = getProfileData(ensureActiveProfile()); loadSheetToUI(d); });
      if (pjSan) pjSan.addEventListener(evt, () => { saveSheet(); const d = getProfileData(ensureActiveProfile()); loadSheetToUI(d); });

      ["pjHpMax","pjSanMax","pjWounds","pjTroubles","combat_ranged","combat_melee","combat_prot","w1_name","w1_dmg","w2_name","w2_dmg"].forEach(id => {
        const el = $(id);
        if (el) el.addEventListener(evt, () => { saveSheet(); const d = getProfileData(ensureActiveProfile()); loadSheetToUI(d); });
      });

      ["for","dex","end","int","intu"].forEach(k => {
        const r = $(`stat_${k}`);
        const m = $(`stat_${k}_max`);
        if (r) r.addEventListener(evt, () => { saveSheet(); const d = getProfileData(ensureActiveProfile()); loadSheetToUI(d); });
        if (m) m.addEventListener(evt, () => { saveSheet(); const d = getProfileData(ensureActiveProfile()); loadSheetToUI(d); });
      });

      document.querySelectorAll("#skillsGrid input[data-skill]").forEach(inp => {
        inp.addEventListener(evt, saveSheet);
      });
    });

    // Comp√©tences sp√©ciales
    const addSpecBtn = $("addSpec");
    if (addSpecBtn){
      addSpecBtn.addEventListener("click", () => {
        const name = ($("specName")?.value || "").trim();
        const val = Number($("specVal")?.value || 0);
        if (!name) return;

        const id = ensureActiveProfile();
        if (!id) return;
        const data = getProfileData(id);
        data.sheet.specials = Array.isArray(data.sheet?.specials) ? data.sheet.specials : [];
        data.sheet.specials.unshift({ id: uid(), name, val });
        setProfileData(id, data);

        if ($("specName")) $("specName").value = "";
        if ($("specVal")) $("specVal").value = "";
        renderSpecials(data.sheet.specials);
      });
    }

    // Journal
    const btnSaveLog = $("saveLog");
    const btnClearLog = $("clearLog");
    if (btnSaveLog) btnSaveLog.addEventListener("click", saveLogOnly);
    if (btnClearLog) btnClearLog.addEventListener("click", () => { if ($("log")) $("log").value = ""; saveLogOnly(); });

    // INVENTAIRE
    function renderInv(){
      const id = ensureActiveProfile();
      const data = id ? getProfileData(id) : defaultProfileData();

      const itemsUl = $("items");
      if (!itemsUl) return;

      const arr = Array.isArray(data.inv) ? data.inv : [];
      itemsUl.innerHTML = "";

      arr.forEach((txt, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${escapeHtml(txt)}</span><button class="mini" data-i="${idx}" type="button">X</button>`;
        itemsUl.appendChild(li);
      });

      itemsUl.querySelectorAll("button.mini").forEach(b => {
        b.addEventListener("click", () => {
          const id2 = ensureActiveProfile();
          if (!id2) return;
          const d2 = getProfileData(id2);
          const inv2 = Array.isArray(d2.inv) ? d2.inv : [];
          inv2.splice(Number(b.dataset.i), 1);
          d2.inv = inv2;
          setProfileData(id2, d2);
          renderInv();
        });
      });
    }

    const btnAddItem = $("addItem");
    if (btnAddItem) btnAddItem.addEventListener("click", () => {
      const input = $("itemInput");
      const val = input ? input.value.trim() : "";
      if (!val) return;

      const id = ensureActiveProfile();
      if (!id) return;

      const data = getProfileData(id);
      const inv = Array.isArray(data.inv) ? data.inv : [];
      inv.unshift(val);
      data.inv = inv;
      setProfileData(id, data);

      if (input) input.value = "";
      renderInv();
    });

    const btnClearInv = $("clearInv");
    if (btnClearInv) btnClearInv.addEventListener("click", () => {
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.inv = [];
      setProfileData(id, data);
      renderInv();
    });

    // QU√äTES
    const questTitle = $("questTitle");
    const addQuestBtn = $("addQuest");
    const questFilter = $("questFilter");
    const questsBox = $("quests");
    const questCounts = $("questCounts");
    const clearDoneObjectivesBtn = $("clearDoneObjectives");

    function newQuest(title){
      return { id: uid(), title, status: "EN_COURS", notes: "", objectives: [] };
    }

    function getQuestData(){
      const id = ensureActiveProfile();
      if (!id) return [];
      const data = getProfileData(id);
      return Array.isArray(data.quests) ? data.quests : [];
    }

    function setQuestData(quests){
      const id = ensureActiveProfile();
      if (!id) return;
      const data = getProfileData(id);
      data.quests = quests;
      setProfileData(id, data);
    }

    function renderQuests(){
      if (!questsBox) return;

      const mode = questFilter ? questFilter.value : "BOARD";
      const quests = getQuestData();

      const cEn = quests.filter(q => q.status === "EN_COURS").length;
      const cOk = quests.filter(q => q.status === "OK").length;
      const cRa = quests.filter(q => q.status === "RATEE").length;
      if (questCounts) questCounts.textContent = `EN COURS (${cEn}) ‚Ä¢ OK (${cOk}) ‚Ä¢ RAT√âE (${cRa})`;

      const statusLabel = { EN_COURS: "EN COURS", OK: "OK", RATEE: "RAT√âE" };
      const order = { EN_COURS: 0, OK: 1, RATEE: 2 };

      let shown = quests.slice();
      if (mode === "BOARD"){
        shown.sort((a,b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));
      } else if (mode !== "ALL"){
        shown = shown.filter(q => q.status === mode);
      }

      if (shown.length === 0){
        questsBox.innerHTML = `<p class="hint">Aucune qu√™te pour ce profil (ou filtre vide).</p>`;
        return;
      }

      let html = "";
      let lastStatus = null;

      for (const q of shown){
        if (mode === "BOARD" && q.status !== lastStatus){
          lastStatus = q.status;
          html += `<div class="questSection"><div class="questSectionTitle">${statusLabel[q.status] ?? q.status}</div></div>`;
        }

        const obj = Array.isArray(q.objectives) ? q.objectives : [];
        const objHtml = obj.map(o => `
          <li class="objLine">
            <label class="objLabel">
              <input type="checkbox" data-act="toggleObj" data-q="${q.id}" data-o="${o.id}" ${o.done ? "checked":""}>
              <span>${escapeHtml(o.text)}</span>
            </label>
            <button class="mini" type="button" data-act="delObj" data-q="${q.id}" data-o="${o.id}">X</button>
          </li>
        `).join("");

        html += `
          <div class="quest" data-q="${q.id}">
            <div class="questHead">
              <div class="questTitle">${escapeHtml(q.title)}</div>
              <button class="mini danger" type="button" data-act="delQuest" data-q="${q.id}">SUPPR</button>
            </div>

            <div class="row">
              <select data-act="setStatus" data-q="${q.id}">
                <option value="EN_COURS" ${q.status==="EN_COURS"?"selected":""}>EN COURS</option>
                <option value="OK" ${q.status==="OK"?"selected":""}>OK</option>
                <option value="RATEE" ${q.status==="RATEE"?"selected":""}>RAT√âE</option>
              </select>
            </div>

            <textarea rows="3" placeholder="Notes‚Ä¶" data-act="notes" data-q="${q.id}">${escapeHtml(q.notes || "")}</textarea>

            <div class="row">
              <input type="text" placeholder="Ajouter un objectif‚Ä¶" data-act="objInput" data-q="${q.id}">
              <button type="button" data-act="addObj" data-q="${q.id}">+</button>
            </div>

            <ul class="objList">${objHtml || `<li class="hint">Aucun objectif.</li>`}</ul>
          </div>
        `;
      }

      questsBox.innerHTML = html;
    }

    if (addQuestBtn) addQuestBtn.addEventListener("click", () => {
      const title = questTitle ? questTitle.value.trim() : "";
      if (!title) return;
      const quests = getQuestData();
      quests.unshift(newQuest(title));
      setQuestData(quests);
      if (questTitle) questTitle.value = "";
      renderQuests();
    });

    if (questFilter) questFilter.addEventListener("change", renderQuests);

    if (clearDoneObjectivesBtn) clearDoneObjectivesBtn.addEventListener("click", () => {
      const quests = getQuestData();
      quests.forEach(q => {
        q.objectives = (Array.isArray(q.objectives) ? q.objectives : []).filter(o => !o.done);
      });
      setQuestData(quests);
      renderQuests();
    });

    if (questsBox) {
      questsBox.addEventListener("click", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        const oid = t.getAttribute("data-o");
        if (!act || !qid) return;

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q) return;

        if (act === "delQuest"){
          setQuestData(quests.filter(x => x.id !== qid));
          renderQuests();
          return;
        }

        if (act === "addObj"){
          const input = questsBox.querySelector(`input[data-act="objInput"][data-q="${qid}"]`);
          const text = (input && input.value) ? input.value.trim() : "";
          if (!text) return;
          q.objectives = Array.isArray(q.objectives) ? q.objectives : [];
          q.objectives.push({ id: uid(), text, done:false });
          setQuestData(quests);
          renderQuests();
          return;
        }

        if (act === "delObj" && oid){
          q.objectives = (Array.isArray(q.objectives) ? q.objectives : []).filter(o => o.id !== oid);
          setQuestData(quests);
          renderQuests();
          return;
        }
      });

      questsBox.addEventListener("change", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        const oid = t.getAttribute("data-o");

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q) return;

        if (act === "setStatus" && t instanceof HTMLSelectElement){
          q.status = t.value;
          setQuestData(quests);
          renderQuests();
          return;
        }

        if (act === "toggleObj" && t instanceof HTMLInputElement && oid){
          q.objectives = Array.isArray(q.objectives) ? q.objectives : [];
          const o = q.objectives.find(x => x.id === oid);
          if (o) o.done = !!t.checked;
          setQuestData(quests);
          renderQuests();
        }
      });

      questsBox.addEventListener("blur", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const act = t.getAttribute("data-act");
        const qid = t.getAttribute("data-q");
        if (act !== "notes" || !qid) return;

        const quests = getQuestData();
        const q = quests.find(x => x.id === qid);
        if (!q || !(t instanceof HTMLTextAreaElement)) return;

        q.notes = t.value;
        setQuestData(quests);
      }, true);
    }

    // ===== DIAGNOSTIC =====
    const copyDiagBtn = $("copyDiag");
    if (copyDiagBtn) copyDiagBtn.addEventListener("click", async () => {
      const id = ensureActiveProfile();
      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id);
      const data = id ? getProfileData(id) : defaultProfileData();
      const sh = data.sheet || defaultProfileData().sheet;

      const q = Array.isArray(data.quests) ? data.quests : [];
      const cEn = q.filter(x => x.status === "EN_COURS").length;
      const cOk = q.filter(x => x.status === "OK").length;
      const cRa = q.filter(x => x.status === "RATEE").length;

      const diag = [
        `PIPBOY ${APP_VERSION}`,
        `Profil: ${(meta && meta.name) ? meta.name : "?"} (${id || "no-id"})`,
        `Campagne: ${(meta && meta.campaign) ? meta.campaign : "‚Äî"}`,
        `PV: ${sh.hp}/${sh.hpMax} | SAN: ${sh.san}/${sh.sanMax}`,
        `Quetes: EN_COURS ${cEn} | OK ${cOk} | RATEE ${cRa}`,
        `URL: ${location.href}`,
        `UA: ${navigator.userAgent}`
      ].join("\n");

      try {
        await navigator.clipboard.writeText(diag);
        alert("Diagnostic copi√© ‚úÖ");
      } catch {
        alert("Copie impossible (le navigateur bloque).");
      }
    });

    // ===== PROFILS =====
    if (profileSelect) profileSelect.addEventListener("change", () => {
      setActiveId(profileSelect.value);
      loadActiveProfileToUI();
    });

    const btnNewProfile = $("newProfile");
    if (btnNewProfile) btnNewProfile.addEventListener("click", () => {
      const profiles = getProfiles();
      const id = uid();
      const name = `P${profiles.length + 1}`;
      profiles.push({ id, name, campaign: "ORION", createdAt: new Date().toISOString() });
      setProfiles(profiles);
      setProfileData(id, defaultProfileData());
      setActiveId(id);
      loadActiveProfileToUI();
    });

    const btnSaveName = $("saveProfileName");
    if (btnSaveName) btnSaveName.addEventListener("click", () => {
      const id = ensureActiveProfile();
      if (!id) return;

      const newName = (profileName ? profileName.value : "").trim();
      const newCampaign = (profileCampaign ? profileCampaign.value : "").trim();

      const profiles = getProfiles();
      const p = profiles.find(x => x.id === id);
      if (p) {
        if (newName) p.name = newName;
        p.campaign = newCampaign;
      }
      setProfiles(profiles);
      refreshProfilesUI();
      loadActiveProfileToUI();
    });

    const btnDeleteProfile = $("deleteProfile");
    if (btnDeleteProfile) btnDeleteProfile.addEventListener("click", () => {
      const profiles = getProfiles();
      if (profiles.length <= 1){
        alert("Impossible: il faut garder au moins 1 profil.");
        return;
      }
      const id = ensureActiveProfile();
      const p = profiles.find(x => x.id === id);
      const ok = confirm(`Supprimer le profil "${p ? p.name : id}" ?`);
      if (!ok) return;

      const filtered = profiles.filter(x => x.id !== id);
      setProfiles(filtered);
      deleteProfileData(id);

      setActiveId(filtered[0].id);
      loadActiveProfileToUI();
    });

    // ===== EXPORT / IMPORT (tous profils) =====
    const backupBox = $("backupBox");

    function exportAll(){
      const payload = {
        v: 3,
        exportedAt: new Date().toISOString(),
        activeProfileId: getActiveId(),
        profiles: getProfiles(),
        dataByProfile: {}
      };

      payload.profiles.forEach(p => {
        payload.dataByProfile[p.id] = getProfileData(p.id);
      });

      if (backupBox) backupBox.value = JSON.stringify(payload, null, 2);

      try {
        const blob = new Blob([backupBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {}
    }

    function applyImport(){
      if (!backupBox) return;

      let obj;
      try { obj = JSON.parse(backupBox.value); }
      catch { alert("JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object") { alert("JSON invalide"); return; }

      // CAS 1 : Full backup
      if (Array.isArray(obj.profiles) && obj.dataByProfile && typeof obj.dataByProfile === "object") {
        const incomingProfiles = obj.profiles
          .filter(p => p && typeof p === "object" && typeof p.id === "string" && p.id.trim().length > 0)
          .map(p => ({
            id: p.id,
            name: (typeof p.name === "string" && p.name.trim()) ? p.name.trim() : "Profil",
            campaign: (typeof p.campaign === "string") ? p.campaign.trim() : "",
            createdAt: p.createdAt || new Date().toISOString()
          }));

        if (incomingProfiles.length === 0){
          alert("Backup invalide: aucun profil d√©tect√©.");
          return;
        }

        setProfiles(incomingProfiles);

        incomingProfiles.forEach(p => {
          const d = obj.dataByProfile[p.id];
          setProfileData(p.id, d || defaultProfileData());
        });

        const requestedActive = (typeof obj.activeProfileId === "string") ? obj.activeProfileId : null;
        const activeOk = requestedActive && incomingProfiles.some(p => p.id === requestedActive);
        setActiveId(activeOk ? requestedActive : incomingProfiles[0].id);

        loadActiveProfileToUI();
        alert("Import complet appliqu√© ‚úÖ");
        return;
      }

      // CAS 2 : Import ‚Äúprofil-like‚Äù vers profil actif
      if (obj.sheet || obj.log || obj.inv || obj.quests) {
        const id = ensureActiveProfile();
        const data = getProfileData(id);

        if (typeof obj.log === "string") data.log = obj.log;
        if (Array.isArray(obj.inv)) data.inv = obj.inv;
        if (Array.isArray(obj.quests)) data.quests = obj.quests;
        if (obj.sheet && typeof obj.sheet === "object") data.sheet = obj.sheet;

        setProfileData(id, data);
        loadActiveProfileToUI();
        alert("Import appliqu√© sur le profil actif ‚úÖ");
        return;
      }

      alert("Format non reconnu üòµ‚Äçüí´");
    }

    const btnExport = $("exportAll");
    const btnClear  = $("clearBox");
    const btnApply  = $("applyImport");

    if (btnExport) btnExport.addEventListener("click", exportAll);
    if (btnClear && backupBox) btnClear.addEventListener("click", () => { backupBox.value = ""; });
    if (btnApply) btnApply.addEventListener("click", applyImport);

    const fileImport = $("fileImport");
    if (fileImport) {
      fileImport.addEventListener("change", async () => {
        const file = fileImport.files && fileImport.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (backupBox) backupBox.value = text;
          applyImport();
        } catch {
          alert("Impossible de lire le fichier üòµ‚Äçüí´");
        } finally {
          fileImport.value = "";
        }
      });
    }

    // ===== EXPORT / IMPORT : PROFIL ACTIF =====
    const backupProfileBox = $("backupProfileBox");

    function exportActiveProfile(){
      const id = ensureActiveProfile();
      if (!id || !backupProfileBox) return;

      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id) || { id, name: "Profil", campaign: "", createdAt: "" };

      const payload = {
        v: 2,
        exportedAt: new Date().toISOString(),
        profile: meta,
        data: getProfileData(id)
      };

      backupProfileBox.value = JSON.stringify(payload, null, 2);

      try {
        const safeName = (meta.name || "profil").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
        const blob = new Blob([backupProfileBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-${safeName || "profil"}-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {}
    }

    function applyImportActiveProfile(){
      const id = ensureActiveProfile();
      if (!id || !backupProfileBox) return;

      let obj;
      try { obj = JSON.parse(backupProfileBox.value); }
      catch { alert("JSON invalide üòµ‚Äçüí´"); return; }

      let data = null;
      let meta = null;

      if (obj && typeof obj === "object" && obj.data && typeof obj.data === "object") {
        data = obj.data;
        if (obj.profile && typeof obj.profile === "object") meta = obj.profile;
      } else if (obj && typeof obj === "object" && (obj.sheet || obj.log || obj.inv || obj.quests)) {
        data = {
          log: (typeof obj.log === "string") ? obj.log : "",
          inv: Array.isArray(obj.inv) ? obj.inv : [],
          quests: Array.isArray(obj.quests) ? obj.quests : [],
          sheet: (obj.sheet && typeof obj.sheet === "object") ? obj.sheet : defaultProfileData().sheet
        };
      }

      if (!data) { alert("Format non reconnu üòµ‚Äçüí´"); return; }

      setProfileData(id, data);

      // applique aussi le nom / campagne si pr√©sent
      if (meta && (meta.name || meta.campaign)) {
        const profiles = getProfiles();
        const p = profiles.find(x => x.id === id);
        if (p){
          if (typeof meta.name === "string" && meta.name.trim()) p.name = meta.name.trim();
          if (typeof meta.campaign === "string") p.campaign = meta.campaign.trim();
          setProfiles(profiles);
        }
      }

      loadActiveProfileToUI();
      alert("Profil actif mis √† jour ‚úÖ (nom/campagne inclus si pr√©sents)");
    }

    const btnExportActive = $("exportActive");
    const btnApplyActive  = $("applyImportActive");
    const btnClearActive  = $("clearProfileBox");

    if (btnExportActive) btnExportActive.addEventListener("click", exportActiveProfile);
    if (btnApplyActive) btnApplyActive.addEventListener("click", applyImportActiveProfile);
    if (btnClearActive && backupProfileBox) btnClearActive.addEventListener("click", () => { backupProfileBox.value = ""; });

    const fileImportActive = $("fileImportActive");
    if (fileImportActive) {
      fileImportActive.addEventListener("change", async () => {
        const file = fileImportActive.files && fileImportActive.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (backupProfileBox) backupProfileBox.value = text;
          applyImportActiveProfile();
        } catch {
          alert("Impossible de lire le fichier üòµ‚Äçüí´");
        } finally {
          fileImportActive.value = "";
        }
      });
    }

    // ===== PACK MJ =====
    const packProfileBox = $("packProfileBox");
    const btnExportPackActive = $("exportPackActive");
    const btnApplyPackActive = $("applyPackActive");
    const btnClearPackProfileBox = $("clearPackProfileBox");
    const fileImportPackActive = $("fileImportPackActive");

    function normalizeQuest(q){
      const out = Object.assign({ id: uid(), title: "", status: "EN_COURS", notes: "", objectives: [], mj: {} }, q || {});
      out.objectives = Array.isArray(out.objectives) ? out.objectives : [];
      out.mj = (out.mj && typeof out.mj === "object") ? out.mj : {};
      return out;
    }

    function mergeObjectives(existing, incoming){
      const ex = Array.isArray(existing) ? existing : [];
      const inc = Array.isArray(incoming) ? incoming : [];

      const exById = new Map(ex.filter(o => o && o.id).map(o => [o.id, o]));
      const merged = [];

      for (const o of inc){
        const obj = Object.assign({ id: uid(), text: "", done: false }, o || {});
        const same = obj.id ? exById.get(obj.id) : null;
        if (same){
          merged.push({ id: obj.id, text: (obj.text ?? same.text ?? ""), done: !!same.done });
        } else {
          merged.push({ id: obj.id, text: obj.text ?? "", done: !!obj.done });
        }
      }

      const incIds = new Set(merged.map(x => x.id));
      for (const o of ex){
        if (o && o.id && !incIds.has(o.id)){
          merged.push({ id: o.id, text: o.text ?? "", done: !!o.done });
        }
      }
      return merged;
    }

    function mergeQuests(existingQuests, incomingQuests){
      const ex = (Array.isArray(existingQuests) ? existingQuests : []).map(normalizeQuest);
      const inc = (Array.isArray(incomingQuests) ? incomingQuests : []).map(normalizeQuest);

      const exById = new Map(ex.filter(q => q.id).map(q => [q.id, q]));
      const merged = [];

      for (const q of inc){
        const same = q.id ? exById.get(q.id) : null;
        if (same){
          merged.push({
            id: q.id,
            title: q.title || same.title,
            status: same.status || q.status || "EN_COURS",
            notes: (same.notes && String(same.notes).trim().length > 0) ? same.notes : (q.notes || ""),
            objectives: mergeObjectives(same.objectives, q.objectives),
            mj: Object.assign({}, same.mj || {}, q.mj || {})
          });
        } else {
          merged.push(q);
        }
      }

      const incIds = new Set(merged.map(x => x.id));
      for (const q of ex){
        if (q && q.id && !incIds.has(q.id)){
          merged.push(q);
        }
      }

      return merged;
    }

    function exportPackActive(){
      const id = ensureActiveProfile();
      if (!id || !packProfileBox) return;

      const profiles = getProfiles();
      const meta = profiles.find(p => p.id === id) || { id, name: "Profil", campaign: "" };
      const data = getProfileData(id);

      const payload = {
        kind: "pipboy_pack_mj",
        v: 3,
        exportedAt: new Date().toISOString(),
        campaignId: (meta.campaign || "").trim() || "ORION",
        targetProfileName: meta.name,
        briefing: "",
        quests: (Array.isArray(data.quests) ? data.quests : []).map(normalizeQuest)
      };

      packProfileBox.value = JSON.stringify(payload, null, 2);

      try {
        const safeName = (meta.name || "profil").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
        const blob = new Blob([packProfileBox.value], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pipboy-pack-${safeName || "profil"}-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {}
    }

    function applyPackActive(){
      const id = ensureActiveProfile();
      if (!id || !packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object") { alert("Pack MJ invalide"); return; }
      if (obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)) {
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const data = getProfileData(id);
      data.quests = mergeQuests(data.quests, obj.quests);

      if (obj.briefing && String(obj.briefing).trim().length > 0){
        const stamp = new Date().toISOString().slice(0,10);
        const header = `[PACK MJ ${obj.campaignId || ""} ${stamp}]`.trim();
        const block = `${header}\n${obj.briefing}\n\n`;
        data.log = block + (data.log || "");
      }

      setProfileData(id, data);
      loadActiveProfileToUI();
      alert("Pack MJ appliqu√© ‚úÖ (fusion + briefing)");
    }

    const btnApplyPackAllProfiles = $("applyPackAllProfiles");
    function applyPackAllProfiles(){
      const profiles = getProfiles();
      if (!profiles || profiles.length === 0) return;
      if (!packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object" || obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)){
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const ok = confirm(`Appliquer ce Pack MJ √† TOUS les profils de ce t√©l√©phone ? (${profiles.length})`);
      if (!ok) return;

      for (const p of profiles){
        const data = getProfileData(p.id);
        data.quests = mergeQuests(data.quests, obj.quests);

        if (obj.briefing && String(obj.briefing).trim().length > 0){
          const stamp = new Date().toISOString().slice(0,10);
          const header = `[PACK MJ ${obj.campaignId || ""} ${stamp}]`.trim();
          const block = `${header}\n${obj.briefing}\n\n`;
          data.log = block + (data.log || "");
        }

        setProfileData(p.id, data);
      }

      loadActiveProfileToUI();
      alert("Pack MJ appliqu√© √† tous les profils ‚úÖ");
    }

    const btnApplyPackCampaign = $("applyPackCampaign");
    function applyPackCampaign(){
      const profiles = getProfiles();
      if (!profiles || profiles.length === 0) return;
      if (!packProfileBox) return;

      let obj;
      try { obj = JSON.parse(packProfileBox.value); }
      catch { alert("Pack MJ: JSON invalide üòµ‚Äçüí´"); return; }

      if (!obj || typeof obj !== "object" || obj.kind !== "pipboy_pack_mj" || !Array.isArray(obj.quests)){
        alert("Ce JSON n‚Äôest pas un Pack MJ PipBoy.");
        return;
      }

      const campaignId = String(obj.campaignId || "").trim();
      if (!campaignId){
        alert("Pack MJ: campaignId manquant. (Ex: ORION)");
        return;
      }

      const targets = profiles.filter(p => String(p.campaign || "").trim() === campaignId);
      if (targets.length === 0){
        alert(`Aucun profil avec la campagne "${campaignId}".`);
        return;
      }

      const ok = confirm(`Appliquer le Pack MJ campagne "${campaignId}" √† ${targets.length} profil(s) ?`);
      if (!ok) return;

      for (const p of targets){
        const data = getProfileData(p.id);
        data.quests = mergeQuests(data.quests, obj.quests);

        if (obj.briefing && String(obj.briefing).trim().length > 0){
          const stamp = new Date().toISOString().slice(0,10);
          const header = `[PACK MJ ${campaignId} ${stamp}]`;
          const block = `${header}\n${obj.briefing}\n\n`;
          data.log = block + (data.log || "");
        }

        setProfileData(p.id, data);
      }

      loadActiveProfileToUI();
      alert(`Pack MJ appliqu√© √† la campagne "${campaignId}" ‚úÖ`);
    }

    if (btnExportPackActive) btnExportPackActive.addEventListener("click", exportPackActive);
    if (btnApplyPackActive) btnApplyPackActive.addEventListener("click", applyPackActive);
    if (btnApplyPackAllProfiles) btnApplyPackAllProfiles.addEventListener("click", applyPackAllProfiles);
    if (btnApplyPackCampaign) btnApplyPackCampaign.addEventListener("click", applyPackCampaign);
    if (btnClearPackProfileBox && packProfileBox) btnClearPackProfileBox.addEventListener("click", () => { packProfileBox.value = ""; });

    if (fileImportPackActive) {
      fileImportPackActive.addEventListener("change", async () => {
        const file = fileImportPackActive.files && fileImportPackActive.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          if (packProfileBox) packProfileBox.value = text;
          applyPackActive();
        } catch {
          alert("Impossible de lire le pack üòµ‚Äçüí´");
        } finally {
          fileImportPackActive.value = "";
        }
      });
    }

    // Chargement initial
    refreshProfilesUI();
    loadActiveProfileToUI();

    // PWA offline
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js", { scope: "./" });
    }
  </script>
</body>
</html>
